<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Placement Tracker - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f8f9fa;
    }

    .sidebar {
      height: 100vh;
      width: 240px;
      position: fixed;
      top: 0;
      left: 0;
      background: #212529;
      color: #fff;
      padding-top: 20px;
    }

    .sidebar h4 {
      color: #0d6efd;
      padding-left: 15px;
    }

    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: #ddd;
      text-decoration: none;
      transition: 0.3s;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: #0d6efd;
      color: #fff;
    }

    .content {
      margin-left: 240px;
      padding: 20px;
    }

    .card-shadow {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h4 class="mb-4 px-3">üéì Admin</h4>
    <a href="#" class="nav-link active" data-section="companies">üè¢ Companies</a>
    <a href="#" class="nav-link" data-section="users">üë§ Users</a>
    <a href="#" class="nav-link" data-section="applications">üì© Applications</a>
    <hr class="bg-light" />
    <button id="logoutBtn" class="btn btn-danger btn-sm ms-3">Logout</button>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Companies Section -->
    <div id="companies" class="section active">
      <div class="card card-shadow p-3 mb-4">
        <h4>üè¢ Manage Companies</h4>
        <form id="companyForm" class="row g-2 mb-3">
          <div class="col-md-4"><input type="text" id="companyName" class="form-control" placeholder="Company Name"
              required /></div>
          <div class="col-md-4"><input type="text" id="companyRole" class="form-control" placeholder="Role" required />
          </div>
          <div class="col-md-3"><input type="text" id="companyCTC" class="form-control" placeholder="Package" /></div>
          <div class="col-md-1 d-grid"><button type="submit" class="btn btn-primary">‚ûï</button></div>
        </form>
        <div id="companiesTable"></div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="users" class="section">
      <div class="card card-shadow p-3">
        <h4>üë§ Manage Users</h4>
        <div id="usersTable"></div>
      </div>
    </div>

    <!-- Applications Section -->
    <div id="applications" class="section">
      <div class="card card-shadow p-3">
        <h4>üì© Manage Applications</h4>

        <!-- üîπ Filters -->
        <div class="row mb-3">
          <div class="col-md-4">
            <select id="companyFilter" class="form-select">
              <option value="">All Companies</option>
            </select>
          </div>
          <div class="col-md-4">
            <select id="companyRoleFilter" class="form-select">
              <option value="">All Roles</option>
            </select>
          </div>
          <div class="col-md-4">
            <button class="btn btn-secondary w-100" id="resetFilters">Reset Filters</button>
          </div>
        </div>

        <div id="applicationsTable"></div>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">User Details</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="userDetailsBody">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Firebase + Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDgekQbFWteKgJqEJMVNbesd06LFRfv00U",
      authDomain: "my-one-dbc60.firebaseapp.com",
      projectId: "my-one-dbc60",
      storageBucket: "my-one-dbc60.appspot.com",
      messagingSenderId: "878020879440",
      appId: "1:878020879440:web:9e726d0aa0f7dd93231d55"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'index.html';
    });

    // Sidebar Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(link.dataset.section).classList.add('active');
      });
    });

    // Add Company
    const companyForm = document.getElementById('companyForm');
    companyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('companyName').value;
      const role = document.getElementById('companyRole').value;
      const ctc = document.getElementById('companyCTC').value;
      await addDoc(collection(db, 'companies'), { name, role, ctc });
      companyForm.reset();
    });

    // Render Companies
    function renderCompanies() {
      const companiesTable = document.getElementById('companiesTable');
      onSnapshot(collection(db, 'companies'), (snapshot) => {
        let html = `
          <table class="table table-bordered table-sm align-middle">
            <thead class="table-dark"><tr><th>Name</th><th>Role</th><th>Package</th><th>Actions</th></tr></thead>
            <tbody>
        `;
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          html += `
            <tr>
              <td>${data.name}</td>
              <td>${data.role}</td>
              <td>${data.ctc}</td>
              <td>
                <button class="btn btn-sm btn-warning editCompany" data-id="${docSnap.id}">Edit</button>
                <button class="btn btn-sm btn-danger deleteCompany" data-id="${docSnap.id}">Delete</button>
              </td>
            </tr>`;
        });
        html += `</tbody></table>`;
        companiesTable.innerHTML = html;

        document.querySelectorAll('.deleteCompany').forEach(btn =>
          btn.addEventListener('click', async () => {
            if (confirm('Delete this company?')) await deleteDoc(doc(db, 'companies', btn.dataset.id));
          })
        );

        document.querySelectorAll('.editCompany').forEach(btn =>
          btn.addEventListener('click', async () => {
            const companyDoc = doc(db, 'companies', btn.dataset.id);
            const newName = prompt('New name:');
            const newRole = prompt('New role:');
            const newCTC = prompt('New Package:');
            if (newName && newRole && newCTC) {
              await updateDoc(companyDoc, { name: newName, role: newRole, ctc: newCTC });
            }
          })
        );
      });
    }
    renderCompanies();

    // Manage Users
    async function loadUsers() {
      const usersTable = document.getElementById('usersTable');
      const usersSnap = await getDocs(collection(db, 'users'));
      let html = `
        <table class="table table-bordered table-sm align-middle">
          <thead class="table-dark"><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
          <tbody>`;
      usersSnap.forEach(userDoc => {
        const user = userDoc.data();
        html += `
          <tr>
            <td>${user.name || "-"}</td>
            <td>${user.email || "-"}</td>
            <td>
              <select class="form-select form-select-sm userRoleSelect" data-id="${userDoc.id}">
                <option value="student" ${user.role === "student" ? "selected" : ""}>Student</option>
                <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
              </select>
            </td>
            <td>
              <button class="btn btn-sm btn-danger deleteUser" data-id="${userDoc.id}">Delete</button>
            </td>
          </tr>`;
      });
      html += `</tbody></table>`;
      usersTable.innerHTML = html;

      document.querySelectorAll('.userRoleSelect').forEach(sel =>
        sel.addEventListener('change', async () => {
          await updateDoc(doc(db, 'users', sel.dataset.id), { role: sel.value });
          loadUsers();
        })
      );

      document.querySelectorAll('.deleteUser').forEach(btn =>
        btn.addEventListener('click', async () => {
          if (confirm('Delete user?')) {
            await deleteDoc(doc(db, 'users', btn.dataset.id));
            loadUsers();
          }
        })
      );
    }
    loadUsers();

    // Load Company Filter Options
    async function loadCompanyFilterOptions() {
      const companyFilter = document.getElementById("companyFilter");
      const roleFilter = document.getElementById("companyRoleFilter");

      companyFilter.innerHTML = `<option value="">All Companies</option>`;
      roleFilter.innerHTML = `<option value="">All Roles</option>`;

      const companiesSnap = await getDocs(collection(db, "companies"));
      companiesSnap.forEach(docSnap => {
        const c = docSnap.data();
        if (c.name) {
          const opt = document.createElement("option");
          opt.value = c.name;
          opt.textContent = c.name;
          companyFilter.appendChild(opt);
        }
        if (c.role) {
          const optRole = document.createElement("option");
          optRole.value = c.role;
          optRole.textContent = c.role;
          roleFilter.appendChild(optRole);
        }
      });
    }
    loadCompanyFilterOptions();

    // Manage Applications
    async function loadApplications() {
      const applicationsTable = document.getElementById('applicationsTable');
      const appsSnap = await getDocs(collection(db, 'applications'));

      const selectedCompany = document.getElementById("companyFilter").value;
      const selectedCompanyRole = document.getElementById("companyRoleFilter").value;

      let html = `
        <table class="table table-bordered table-sm align-middle">
          <thead class="table-dark">
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Company</th>
              <th>Role</th>
              <th>Package</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;

      for (const appDoc of appsSnap.docs) {
        const app = appDoc.data();
        if (selectedCompany && app.companyName !== selectedCompany) continue;
        if (selectedCompanyRole && app.role !== selectedCompanyRole) continue;

        html += `
          <tr>
            <td><a href="#" class="userLink" data-id="${app.user}">${app.userName || "-"}</a></td>
            <td>${app.userEmail || "-"}</td>
            <td>${app.companyName || "-"}</td>
            <td>${app.role || "-"}</td>
            <td>${app.ctc || "-"}</td>
            <td>
              <select class="form-select form-select-sm statusSelect" data-id="${appDoc.id}">
                <option value="applied" ${app.status === 'applied' ? 'selected' : ''}>Applied</option>
                <option value="shortlisted" ${app.status === 'shortlisted' ? 'selected' : ''}>Shortlisted</option>
                <option value="interview" ${app.status === 'interview' ? 'selected' : ''}>Interview</option>
                <option value="selected" ${app.status === 'selected' ? 'selected' : ''}>Selected</option>
                <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
              </select>
            </td>
            <td>
              <button class="btn btn-sm btn-danger deleteApplication" data-id="${appDoc.id}">Delete</button>
            </td>
          </tr>`;
      }

      html += `</tbody></table>`;
      applicationsTable.innerHTML = html;

      // Status change
      document.querySelectorAll('.statusSelect').forEach(sel =>
        sel.addEventListener('change', async () => {
          await updateDoc(doc(db, 'applications', sel.dataset.id), { status: sel.value });
          loadApplications();
        })
      );

      // Delete application
      document.querySelectorAll('.deleteApplication').forEach(btn =>
        btn.addEventListener('click', async () => {
          if (confirm('Delete this application?')) {
            await deleteDoc(doc(db, 'applications', btn.dataset.id));
            loadApplications();
          }
        })
      );

      // User details popup
      document.querySelectorAll('.userLink').forEach(link => {
        link.addEventListener('click', async (e) => {
          e.preventDefault();
          const userId = link.dataset.id;
          const userSnap = await getDoc(doc(db, "users", userId));
          if (userSnap.exists()) {
            const u = userSnap.data();
            document.getElementById("userDetailsBody").innerHTML = `
              <p><b>Name:</b> ${u.name || "-"}</p>
              <p><b>Email:</b> ${u.email || "-"}</p>
              <p><b>Branch:</b> ${u.branch || "-"}</p>
              <p><b>Roll No:</b> ${u.rollNo || "-"}</p>
              <p><b>Skills:</b> ${u.skills ? u.skills.join(", ") : "-"}</p>
              <p><b>Phone:</b> ${u.phone || "-"}</p>
              ${u.resumeURL ? `<p><b>Resume:</b> <a href="${u.resumeURL}" target="_blank">View</a></p>` : ""}
            `;
          } else {
            document.getElementById("userDetailsBody").innerHTML = "User details not found.";
          }
          new bootstrap.Modal(document.getElementById('userDetailsModal')).show();
        });
      });
    }

    document.getElementById("companyFilter").addEventListener("change", loadApplications);
    document.getElementById("companyRoleFilter").addEventListener("change", loadApplications);
    document.getElementById("resetFilters").addEventListener("click", () => {
      document.getElementById("companyFilter").value = "";
      document.getElementById("companyRoleFilter").value = "";
      loadApplications();
    });

    loadApplications();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>