<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDgekQbFWteKgJqEJMVNbesd06LFRfv00U",
    authDomain: "my-one-dbc60.firebaseapp.com",
    projectId: "my-one-dbc60",
    storageBucket: "my-one-dbc60.firebasestorage.app",
    messagingSenderId: "878020879440",
    appId: "1:878020879440:web:9e726d0aa0f7dd93231d55"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth);
    window.location.href = 'index.html';
  });

  // Sidebar Navigation
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      const section = link.dataset.section;
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(section).classList.add('active');
    });
  });

  // Add Company
  const companyForm = document.getElementById('companyForm');
  companyForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('companyName').value;
    const role = document.getElementById('companyRole').value;
    const ctc = document.getElementById('companyCTC').value;
    await addDoc(collection(db, 'companies'), { name, role, ctc });
    companyForm.reset();
  });

  // Render Companies
  function renderCompanies() {
    const companiesTable = document.getElementById('companiesTable');
    onSnapshot(collection(db, 'companies'), (snapshot) => {
      let html = `
        <table class="table table-bordered table-sm align-middle">
          <thead class="table-dark"><tr><th>Name</th><th>Role</th><th>CTC</th><th>Actions</th></tr></thead>
          <tbody>
      `;
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        html += `
          <tr>
            <td>${data.name}</td>
            <td>${data.role}</td>
            <td>${data.ctc}</td>
            <td>
              <button class="btn btn-sm btn-warning editCompany" data-id="${docSnap.id}">Edit</button>
              <button class="btn btn-sm btn-danger deleteCompany" data-id="${docSnap.id}">Delete</button>
            </td>
          </tr>`;
      });
      html += `</tbody></table>`;
      companiesTable.innerHTML = html;

      document.querySelectorAll('.deleteCompany').forEach(btn =>
        btn.addEventListener('click', async () => {
          if (confirm('Delete this company?')) await deleteDoc(doc(db, 'companies', btn.dataset.id));
        })
      );

      document.querySelectorAll('.editCompany').forEach(btn =>
        btn.addEventListener('click', async () => {
          const companyDoc = doc(db, 'companies', btn.dataset.id);
          const newName = prompt('New name:');
          const newRole = prompt('New role:');
          const newCTC = prompt('New CTC:');
          if (newName && newRole && newCTC) {
            await updateDoc(companyDoc, { name: newName, role: newRole, ctc: newCTC });
          }
        })
      );
    });
  }
  renderCompanies();

  // Manage Users (with dropdown for role)
  async function loadUsers() {
    const usersTable = document.getElementById('usersTable');
    const usersSnap = await getDocs(collection(db, 'users'));
    let html = `
      <table class="table table-bordered table-sm align-middle">
        <thead class="table-dark"><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
        <tbody>`;
    usersSnap.forEach(userDoc => {
      const user = userDoc.data();
      html += `
        <tr>
          <td>${user.name || "-"}</td>
          <td>${user.email || "-"}</td>
          <td>
            <select class="form-select form-select-sm userRoleSelect" data-id="${userDoc.id}">
              <option value="student" ${user.role === "student" ? "selected" : ""}>Student</option>
              <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
            </select>
          </td>
          <td>
            <button class="btn btn-sm btn-danger deleteUser" data-id="${userDoc.id}">Delete</button>
          </td>
        </tr>`;
    });
    html += `</tbody></table>`;
    usersTable.innerHTML = html;

    document.querySelectorAll('.userRoleSelect').forEach(sel =>
      sel.addEventListener('change', async () => {
        await updateDoc(doc(db, 'users', sel.dataset.id), { role: sel.value });
        loadUsers();
      })
    );

    document.querySelectorAll('.deleteUser').forEach(btn =>
      btn.addEventListener('click', async () => {
        if (confirm('Delete user?')) {
          await deleteDoc(doc(db, 'users', btn.dataset.id));
          loadUsers();
        }
      })
    );
  }
  loadUsers();

  // Manage Applications (with delete)
  async function loadApplications() {
    const applicationsTable = document.getElementById('applicationsTable');
    const appsSnap = await getDocs(collection(db, 'applications'));

    let html = `
      <table class="table table-bordered table-sm align-middle">
        <thead class="table-dark">
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Company</th>
            <th>Role</th>
            <th>CTC</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;

    for (const appDoc of appsSnap.docs) {
      const app = appDoc.data();
      const userName = app.userName || "-";
      const userEmail = app.userEmail || "-";
      const companyName = app.companyName || "-";
      const role = app.role || "-";
      const ctc = app.ctc || "-";

      html += `
        <tr>
          <td>${userName}</td>
          <td>${userEmail}</td>
          <td>${companyName}</td>
          <td>${role}</td>
          <td>${ctc}</td>
          <td>
            <select class="form-select form-select-sm statusSelect" data-id="${appDoc.id}">
              <option value="applied" ${app.status === 'applied' ? 'selected' : ''}>Applied</option>
              <option value="shortlisted" ${app.status === 'shortlisted' ? 'selected' : ''}>Shortlisted</option>
              <option value="interview" ${app.status === 'interview' ? 'selected' : ''}>Interview</option>
              <option value="selected" ${app.status === 'selected' ? 'selected' : ''}>Selected</option>
              <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
            </select>
          </td>
          <td>
            <button class="btn btn-sm btn-danger deleteApplication" data-id="${appDoc.id}">Delete</button>
          </td>
        </tr>
      `;
    }

    html += `</tbody></table>`;
    applicationsTable.innerHTML = html;

    document.querySelectorAll('.statusSelect').forEach(sel =>
      sel.addEventListener('change', async () => {
        await updateDoc(doc(db, 'applications', sel.dataset.id), { status: sel.value });
        loadApplications();
      })
    );

    document.querySelectorAll('.deleteApplication').forEach(btn =>
      btn.addEventListener('click', async () => {
        if (confirm('Delete this application?')) {
          await deleteDoc(doc(db, 'applications', btn.dataset.id));
          loadApplications();
        }
      })
    );
  }
  loadApplications();
</script>