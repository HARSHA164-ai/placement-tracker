<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Placement Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand">üìä Placement Tracker - Admin Dashboard</span>
      <button class="btn btn-danger btn-sm ms-auto" onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Students Section -->
    <h3>üë®‚Äçüéì All Students</h3>
    <table class="table table-bordered mt-3">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Branch</th>
          <th>Roll No</th>
          <th>Skills</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="studentTable"></tbody>
    </table>

    <!-- Companies Section -->
    <h3 class="mt-5">üè¢ Companies</h3>
    <button class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#addCompanyModal">+ Add Company</button>
    <table class="table table-bordered mt-3">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>Role</th>
          <th>Package</th>
          <th>Branches</th>
          <th>Last Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="companyTable"></tbody>
    </table>

    <!-- Applications Section -->
    <h3 class="mt-5">üì© Applications</h3>
    <table class="table table-bordered mt-3">
      <thead class="table-dark">
        <tr>
          <th>Student</th>
          <th>Company</th>
          <th>Role</th>
          <th>Status</th>
          <th>Applied At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="applicationsTable"></tbody>
    </table>
  </div>

  <!-- Add Company Modal -->
  <div class="modal fade" id="addCompanyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Add New Company</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="companyName" class="form-control mb-2" placeholder="Company Name">
          <input type="text" id="companyRole" class="form-control mb-2" placeholder="Role">
          <input type="text" id="companyPackage" class="form-control mb-2" placeholder="Package (e.g. 6 LPA)">
          <input type="text" id="companyBranches" class="form-control mb-2"
            placeholder="Eligible Branches (comma separated)">
          <input type="date" id="companyLastDate" class="form-control mb-2">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="addCompany()">Add Company</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ‚úÖ Check Admin Auth
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        db.collection("admin").doc(user.uid).get().then(doc => {
          if (!doc.exists || doc.data().role !== "admin") {
            alert("Access denied!");
            window.location.href = "index.html";
          } else {
            loadStudents();
            loadCompanies();
            loadApplications();
          }
        });
      }
    });

    // üîπ Load Students
    function loadStudents() {
      db.collection("student").get().then(snapshot => {
        let tableBody = document.getElementById("studentTable");
        tableBody.innerHTML = "";
        snapshot.forEach(doc => {
          const s = doc.data();
          tableBody.innerHTML += `
            <tr>
              <td>${s.name || ""}</td>
              <td>${s.email || ""}</td>
              <td>${s.branch || ""}</td>
              <td>${s.rollNo || ""}</td>
              <td>${s.skills ? s.skills.join(", ") : ""}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="deleteStudent('${doc.id}')">Delete</button>
              </td>
            </tr>
          `;
        });
      });
    }

    // üîπ Load Companies
    function loadCompanies() {
      db.collection("companies").get().then(snapshot => {
        let tableBody = document.getElementById("companyTable");
        tableBody.innerHTML = "";
        snapshot.forEach(doc => {
          const c = doc.data();
          tableBody.innerHTML += `
            <tr>
              <td>${c.name}</td>
              <td>${c.role}</td>
              <td>${c.package}</td>
              <td>${c.branches ? c.branches.join(", ") : ""}</td>
              <td>${c.lastDate}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="deleteCompany('${doc.id}')">Delete</button>
              </td>
            </tr>
          `;
        });
      });
    }

    // üîπ Load Applications
    // üîπ Load Applications with Status Update Option
    // üîπ Load Applications with Status Update & Delete
    async function loadApplications() {
      const appsTable = document.getElementById("applicationsTable");
      appsTable.innerHTML = "";
      const apps = await db.collection("applications").orderBy("appliedAt", "desc").get();

      for (const appDoc of apps.docs) {
        const app = appDoc.data();
        const appId = appDoc.id;
        const student = await db.collection("student").doc(app.studentId).get();
        const company = await db.collection("companies").doc(app.companyId).get();

        appsTable.innerHTML += `
      <tr>
        <td>${student.exists ? student.data().name : "Unknown"}</td>
        <td>${company.exists ? company.data().name : "Unknown"}</td>
        <td>${company.exists ? company.data().role : ""}</td>
        <td>
          <select class="form-select form-select-sm" onchange="updateStatus('${appId}', this.value)">
            <option value="Pending" ${app.status === "Pending" ? "selected" : ""}>Pending</option>
            <option value="Shortlisted" ${app.status === "Shortlisted" ? "selected" : ""}>Shortlisted</option>
            <option value="Selected" ${app.status === "Selected" ? "selected" : ""}>Selected</option>
          </select>
        </td>
        <td>${app.appliedAt?.toDate ? app.appliedAt.toDate().toLocaleString() : ""}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteApplication('${appId}')">Delete</button>
        </td>
      </tr>
    `;
      }
    }

    // üîπ Update Status in Firestore
    function updateStatus(appId, newStatus) {
      db.collection("applications").doc(appId).update({ status: newStatus })
        .then(() => {
          console.log("‚úÖ Status updated to", newStatus);
        })
        .catch(err => alert("‚ùå Error: " + err.message));
    }

    // üîπ Delete Application
    function deleteApplication(appId) {
      if (confirm("Are you sure you want to delete this application?")) {
        db.collection("applications").doc(appId).delete()
          .then(() => {
            alert("üóëÔ∏è Application deleted!");
            loadApplications(); // refresh table
          })
          .catch(err => alert("‚ùå Error: " + err.message));
      }
    }

    // üîπ Update Status in Firestore
    function updateStatus(appId, newStatus) {
      db.collection("applications").doc(appId).update({ status: newStatus })
        .then(() => {
          console.log("‚úÖ Status updated to", newStatus);
        })
        .catch(err => alert("‚ùå Error: " + err.message));
    }

    // üîπ Add Company
    function addCompany() {
      const name = document.getElementById("companyName").value;
      const role = document.getElementById("companyRole").value;
      const pkg = document.getElementById("companyPackage").value;
      const branches = document.getElementById("companyBranches").value.split(",").map(s => s.trim());
      const lastDate = document.getElementById("companyLastDate").value;

      db.collection("companies").add({ name, role, package: pkg, branches, lastDate })
        .then(() => { alert("‚úÖ Company Added!"); loadCompanies(); })
        .catch(err => alert(err.message));
    }

    // üîπ Delete Student
    function deleteStudent(id) {
      if (confirm("Delete this student?")) {
        db.collection("student").doc(id).delete().then(() => loadStudents());
      }
    }

    // üîπ Delete Company
    function deleteCompany(id) {
      if (confirm("Delete this company?")) {
        db.collection("companies").doc(id).delete().then(() => loadCompanies());
      }
    }

    // üîπ Logout
    function logout() {
      firebase.auth().signOut().then(() => window.location.href = "index.html");
    }
  </script>
</body>

</html>