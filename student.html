<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - Placement Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand">üéì Placement Tracker - Student Dashboard</span>
      <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Profile Section -->
    <h3>Welcome, Student!</h3>
    <p class="text-muted">Below are your profile details:</p>

    <div class="card shadow p-4 mt-2">
      <h4>My Profile</h4>
      <hr>
      <p><strong>Name:</strong> <span id="profileName"></span></p>
      <p><strong>Email:</strong> <span id="profileEmail"></span></p>
      <p><strong>Branch:</strong> <span id="profileBranch"></span></p>
      <p><strong>Roll No:</strong> <span id="profileRoll"></span></p>
      <p><strong>Skills:</strong> <span id="profileSkills"></span></p>
      <button class="btn btn-warning mt-2" data-bs-toggle="modal" data-bs-target="#editProfileModal">
        ‚úèÔ∏è Edit Profile
      </button>
    </div>

    <!-- Available Companies Section -->
    <h3 class="mt-5 mb-3">üè¢ Available Companies</h3>
    <div class="row" id="companyList"></div>
  </div>

  <!-- Student Applications Section -->
  <h3 class="mt-5 mb-3">üì© My Applications</h3>
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Company</th>
          <th>Role</th>
          <th>Status</th>
          <th>Applied At</th>
        </tr>
      </thead>
      <tbody id="applicationsTable"></tbody>
    </table>
  </div>


  <!-- üîπ Bootstrap Modal for Edit Profile -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProfileLabel">Edit Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Branch</label>
            <input type="text" id="editBranch" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Roll No</label>
            <input type="text" id="editRollNo" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Skills (comma separated)</label>
            <input type="text" id="editSkills" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" onclick="updateProfile()" data-bs-dismiss="modal">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ‚úÖ Check auth state
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        loadStudentProfile(user.uid);
        loadCompanies(user.uid);
        loadApplications(user.uid);   // ‚úÖ add this line
      }
    });


    // üîπ Load Student Profile
    function loadStudentProfile(studentId) {
      db.collection("student").doc(studentId).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById("profileName").innerText = data.name || "";
          document.getElementById("profileEmail").innerText = data.email || "";
          document.getElementById("profileBranch").innerText = data.branch || "";
          document.getElementById("profileRoll").innerText = data.rollNo || "";
          document.getElementById("profileSkills").innerText = data.skills ? data.skills.join(", ") : "";

          // Pre-fill modal
          document.getElementById("editBranch").value = data.branch || "";
          document.getElementById("editRollNo").value = data.rollNo || "";
          document.getElementById("editSkills").value = data.skills ? data.skills.join(", ") : "";
        }
      }).catch(err => alert("Error: " + err.message));
    }

    // üîπ Update Profile
    function updateProfile() {
      const branch = document.getElementById("editBranch").value;
      const rollNo = document.getElementById("editRollNo").value;
      const skills = document.getElementById("editSkills").value.split(",").map(s => s.trim());

      const user = firebase.auth().currentUser;
      if (user) {
        db.collection("student").doc(user.uid).update({
          branch, rollNo, skills
        }).then(() => {
          alert("‚úÖ Profile updated!");
          document.getElementById("profileBranch").innerText = branch;
          document.getElementById("profileRoll").innerText = rollNo;
          document.getElementById("profileSkills").innerText = skills.join(", ");
        }).catch(err => alert("Error: " + err.message));
      }
    }

    // üîπ Load Companies
    function loadCompanies() {
      const companyList = document.getElementById("companyList");
      companyList.innerHTML = ""; // clear old content

      db.collection("companies").get().then(snapshot => {
        if (snapshot.empty) {
          companyList.innerHTML = `<div class="text-center my-5">No companies available right now.</div>`;
          return;
        }

        snapshot.forEach(doc => {
          const company = doc.data();

          // create column
          const col = document.createElement("div");
          col.className = "col-sm-6 col-md-4 mb-4";

          // card
          col.innerHTML = `
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${company.name}</h5>
            <p class="card-text">
              <strong>Role:</strong> ${company.role}<br>
              <strong>Package:</strong> ${company.package}
            </p>
            <div class="mt-auto">
              <button class="btn btn-primary w-100" onclick="applyJob('${doc.id}')">
                Apply Now
              </button>
            </div>
          </div>
        </div>
      `;

          companyList.appendChild(col);
        });
      });
    }


    // üîπ Apply to Company
    function applyJob(companyId) {
      const user = firebase.auth().currentUser;
      if (!user) return alert("You must be logged in!");

      db.collection("applications").add({
        companyId,
        studentId: user.uid,   // ‚úÖ Always match auth.uid
        status: "Pending",
        appliedAt: firebase.firestore.FieldValue.serverTimestamp() // ‚úÖ server time better
      }).then(() => {
        alert("‚úÖ Application submitted successfully!");
      }).catch(err => alert(err.message));
    }


    // Load Student Applications
    function loadApplications(studentId) {
      const appsTable = document.getElementById("applicationsTable");
      appsTable.innerHTML = `<tr><td colspan="4" class="text-center">Loading applications...</td></tr>`;

      db.collection("applications")
        .where("studentId", "==", studentId)
        .orderBy("appliedAt", "desc")
        .onSnapshot(async (snapshot) => {
          if (snapshot.empty) {
            appsTable.innerHTML = `<tr><td colspan="4" class="text-center">No applications yet.</td></tr>`;
            return;
          }

          appsTable.innerHTML = "";
          for (const appDoc of snapshot.docs) {
            const app = appDoc.data();
            const companyDoc = await db.collection("companies").doc(app.companyId).get();
            const company = companyDoc.exists ? companyDoc.data() : { name: "Unknown", role: "" };

            appsTable.innerHTML += `
          <tr>
            <td>${company.name}</td>
            <td>${company.role}</td>
            <td>
              <span class="badge 
                ${app.status === "Pending" ? "bg-warning text-dark" :
                app.status === "Shortlisted" ? "bg-info text-dark" :
                  "bg-success"}">
                ${app.status}
              </span>
            </td>
            <td>${app.appliedAt.toDate().toLocaleString()}</td>
          </tr>
        `;
          }
        });
    }


    // üîπ Logout
    function logout() {
      firebase.auth().signOut().then(() => window.location.href = "index.html");
    }
  </script>
</body>

</html>